{% extends 'base.html' %}

{% block title %}ระบบวิเคราะห์สต็อกยาง{% endblock %}
{% block page_title %}ระบบวิเคราะห์สต็อกยาง{% endblock %}

{% block content %}
<style>
    .progress-bar-stock {
        height: 10px;
        transition: width 0.6s ease;
    }
    .card-item-container {
        border-radius: .5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
        border: 1px solid #e0e0e0;
        margin-bottom: 1rem;
        transition: transform 0.2s ease-in-out;
    }
    .card-item-container:hover {
        transform: translateY(-3px);
    }
    .status-badge {
        position: absolute;
        bottom: 0;
        right: 0;
        border-top-left-radius: .5rem;
        border-bottom-right-radius: .5rem;
        padding: .25rem .75rem;
        font-size: .75rem;
        font-weight: bold;
    }
    .status-critical { background-color: #dc3545; color: white; }
    .status-warning { background-color: #ffc107; color: #212529; }
    .status-normal { background-color: #f8f9fa; color: #6c757d; border-top: 1px solid #e0e0e0; border-left: 1px solid #e0e0e0;}
    
    .brand-header {
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.75rem;
    }
</style>

<div class="container-fluid px-4">

    {# --- Filter Card --- #}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h6 class="mb-0 text-primary"><i class="fas fa-filter me-2"></i>กรองข้อมูล</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('stock.product_analysis') }}" class="row g-3 align-items-end">
                <div class="col-lg-3 col-md-6">
                    <label for="search_query" class="form-label small text-muted mb-0">ค้นหา (ยี่ห้อ, รุ่น, เบอร์ยาง)</label>
                    <input type="text" class="form-control form-control-sm" id="search_query" name="search_query" value="{{ search_query_filter }}" placeholder="เช่น michelin, pilot sport, 225...">
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="brand_filter" class="form-label small text-muted mb-0">ยี่ห้อ</label>
                    <select id="brand_filter" name="brand_filter" class="form-select form-select-sm">
                        <option value="all">-- ทุกยี่ห้อ --</option>
                        {% for brand in available_tire_brands %}
                            <option value="{{ brand }}" {% if brand == brand_filter %}selected{% endif %}>{{ brand|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="start_date" class="form-label small text-muted mb-0">วันที่เริ่มต้น</label>
                    <input type="date" class="form-control form-control-sm" id="start_date" name="start_date" value="{{ start_date_filter }}">
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="end_date" class="form-label small text-muted mb-0">วันที่สิ้นสุด</label>
                    <input type="date" class="form-control form-control-sm" id="end_date" name="end_date" value="{{ end_date_filter }}">
                </div>
                <div class="col-lg-1 col-md-6">
                    <button type="submit" class="btn btn-primary btn-sm w-100" title="กรองข้อมูล"><i class="fas fa-search"></i> กรอง</button>
                </div>
                {% if current_user.is_admin() %}
                <div class="col-lg-2 col-md-6">
                    <a href="{{ url_for('stock.manage_ignored_items') }}" class="btn btn-secondary btn-sm w-100">
                        <i class="fas fa-eye-slash me-1"></i> จัดการรายการที่ซ่อน
                    </a>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    {# --- Summary Cards --- #}
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-danger mb-3 shadow-sm">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-white-100 small">รายการควรสั่งด่วน</div>
                        <div class="fs-4 fw-bold">{{ (action_items_by_brand.values()|map('length')|sum) }} รายการ</div>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x text-white-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-dark bg-warning mb-3 shadow-sm">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="small">รายการควรสั่งเพิ่ม</div>
                        <div class="fs-4 fw-bold">{{ (low_stock_items_by_brand.values()|map('length')|sum) }} รายการ</div>
                    </div>
                    <i class="fas fa-boxes fa-2x text-dark-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3 shadow-sm">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-white-100 small">สต็อกปกติ</div>
                        <div class="fs-4 fw-bold">{{ (normal_stock_items_by_brand.values()|map('length')|sum) }} รายการ</div>
                    </div>
                    <i class="fas fa-check-circle fa-2x text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    {# --- Main Content: Item Lists --- #}
    {% if not action_items_by_brand and not low_stock_items_by_brand and not normal_stock_items_by_brand %}
        <div class="alert alert-info text-center p-4 fs-5" role="alert">
            <i class="fas fa-info-circle fa-2x mb-3"></i><br>
            ไม่พบข้อมูลยางที่ตรงกับเงื่อนไขการกรองในช่วงเวลานี้ หรือทุกรายการถูกซ่อนแล้ว
        </div>
    {% else %}
        {# --- Action Items Section (Critical) --- #}
        {% if action_items_by_brand %}
            <h5 class="mt-4 mb-3 text-danger"><i class="fas fa-exclamation-circle me-2"></i>รายการควรสั่งด่วน (ด่วน)</h5>
            {% for brand, items_in_brand in action_items_by_brand.items()|sort %}
                <div class="brand-group mb-4">
                    <h6 class="brand-header ps-2 py-1 bg-light border-start border-5 border-secondary text-dark">{{ brand|title }}</h6>
                    <div class="row">
                        {% for item in items_in_brand %}
                            <div class="col-lg-6">
                                {% include 'partials/_analysis_card.html' with context %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        {# --- Low Stock Items Section (Warning) --- #}
        {% if low_stock_items_by_brand %}
            <h5 class="mt-4 mb-3 text-warning"><i class="fas fa-boxes me-2"></i>รายการควรสั่งเพิ่ม(สินค้าใกล้หมด)</h5>
            {% for brand, items_in_brand in low_stock_items_by_brand.items()|sort %}
                <div class="brand-group mb-4">
                    <h6 class="brand-header ps-2 py-1 bg-light border-start border-5 border-secondary text-dark">{{ brand|title }}</h6>
                    <div class="row">
                        {% for item in items_in_brand %}
                            <div class="col-lg-6">
                                {% include 'partials/_analysis_card.html' with context %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        {# --- Normal Stock Items Section --- #}
        {% if normal_stock_items_by_brand %}
            <h5 class="mt-4 mb-3 text-success"><i class="fas fa-check-circle me-2"></i>สต็อกปกติ</h5>
            {% for brand, items_in_brand in normal_stock_items_by_brand.items()|sort %}
                <div class="brand-group mb-4">
                    <h6 class="brand-header ps-2 py-1 bg-light border-start border-5 border-secondary text-dark">{{ brand|title }}</h6>
                    <div class="row">
                        {% for item in items_in_brand %}
                            <div class="col-lg-6">
                                {% include 'partials/_analysis_card.html' with context %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- เปิดใช้งาน Tooltip ---
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        // --- โค้ดสำหรับคำนวณ Lead Time ใหม่ ---
        document.querySelectorAll('.recalculate-btn').forEach(button => {
            button.addEventListener('click', function() {
                const parentItem = this.closest('.card-item-container');
                const input = parentItem.querySelector('.lead-time-input');
                const brandElement = parentItem.querySelector('[data-brand]');
                
                const leadTime = input.value;
                const itemId = input.dataset.itemId;
                const itemType = input.dataset.itemType;
                const brand = brandElement ? brandElement.dataset.brand : null;

                const recCell = parentItem.querySelector('.recommendation-message');
                const ssText = parentItem.querySelector('.safety-stock-value');
                const ropText = parentItem.querySelector('.reorder-point-value');
                const progressBar = parentItem.querySelector('.progress-bar-stock');
                const currentStock = parseInt(parentItem.querySelector('.current-stock-value').textContent);
                
                recCell.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> กำลังคำนวณ...`;
                recCell.classList.remove('alert-danger', 'alert-warning', 'alert-success', 'alert-light');
                recCell.classList.add('alert-info');

                fetch("{{ url_for('stock.api_save_and_recalculate_lead_time') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_id: itemId, item_type: itemType, lead_time: leadTime, brand: brand
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        ssText.textContent = result.data.safety_stock;
                        ropText.textContent = result.data.reorder_point;
                        
                        recCell.classList.remove('alert-info');
                        recCell.innerHTML = `<strong><i class="fas fa-check-circle me-1"></i> ${result.data.recommendation_msg || 'สต็อกเพียงพอ'}</strong>`;
                        
                        if (result.data.recommendation_msg.includes('ด่วน') || result.data.recommendation_msg.includes('ใกล้หมด')) {
                            recCell.classList.add('alert-danger', 'text-white');
                        } else if (result.data.recommendation_msg.includes('ควรสั่ง') || result.data.recommendation_msg.includes('แนะนำให้สั่ง')) {
                            recCell.classList.add('alert-warning');
                        } else {
                            recCell.classList.add('alert-success');
                        }
                        
                        document.querySelectorAll(`[data-brand="${brand}"]`).forEach(el => {
                            const relatedCard = el.closest('.card-item-container');
                            if (relatedCard) {
                                const relatedInput = relatedCard.querySelector('.lead-time-input');
                                if (relatedInput) relatedInput.value = leadTime;
                            }
                        });

                        const maxStock = Math.max(currentStock, result.data.reorder_point, 1);
                        let percentage = (currentStock / maxStock) * 100;
                        percentage = Math.min(Math.max(percentage, 0), 100);

                        progressBar.style.width = `${percentage}%`;
                        if (currentStock <= result.data.safety_stock) {
                            progressBar.className = 'progress-bar progress-bar-stock bg-danger';
                        } else if (currentStock <= result.data.reorder_point) {
                            progressBar.className = 'progress-bar progress-bar-stock bg-warning';
                        } else {
                            progressBar.className = 'progress-bar progress-bar-stock bg-success';
                        }

                    } else {
                        recCell.classList.remove('alert-info');
                        recCell.classList.add('alert-danger', 'text-white');
                        recCell.innerHTML = `<strong>Error: ${result.message}</strong>`;
                    }
                })
                .catch(error => {
                    recCell.classList.remove('alert-info');
                    recCell.classList.add('alert-danger', 'text-white');
                    recCell.innerHTML = `<strong>เกิดข้อผิดพลาดในการเชื่อมต่อ</strong>`;
                    console.error('Fetch error:', error);
                });
            });
        });

        // --- โค้ดสำหรับปุ่ม "ซ่อน" ---
        document.querySelectorAll('.ignore-btn').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const itemType = this.dataset.itemType;
                const container = this.closest('.col-lg-6');

                if (confirm(`คุณต้องการซ่อนรายการนี้ออกจากการวิเคราะห์ใช่หรือไม่? (สามารถจัดการได้ที่หน้า Admin)`)) {
                    fetch("{{ url_for('stock.api_toggle_analysis_status') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_id: itemId,
                            item_type: itemType,
                            ignore: true
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            container.style.transition = 'opacity 0.5s';
                            container.style.opacity = '0';
                            setTimeout(() => {
                                container.remove();
                                location.reload(); // รีเฟรชหน้าเพื่ออัปเดต Summary Cards
                            }, 500);
                        } else {
                            alert('เกิดข้อผิดพลาด: ' + data.message);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });
        });

        // --- ตั้งค่า initial progress bar (เฉพาะตอนโหลดหน้าครั้งแรก) ---
        document.querySelectorAll('.card-item-container').forEach(card => {
            const currentStockEl = card.querySelector('.current-stock-value');
            const safetyStockEl = card.querySelector('.safety-stock-value');
            const reorderPointEl = card.querySelector('.reorder-point-value');
            const progressBar = card.querySelector('.progress-bar-stock');

            if (!currentStockEl || !safetyStockEl || !reorderPointEl || !progressBar) return;

            const currentStock = parseInt(currentStockEl.textContent);
            const safetyStock = parseInt(safetyStockEl.textContent);
            const reorderPoint = parseInt(reorderPointEl.textContent);
            
            const maxVal = Math.max(currentStock, reorderPoint, 1);
            let percentage = (currentStock / maxVal) * 100;
            percentage = Math.min(Math.max(percentage, 0), 100); 

            progressBar.style.width = `${percentage}%`;

            if (currentStock <= safetyStock) {
                progressBar.className = 'progress-bar progress-bar-stock bg-danger';
            } else if (currentStock <= reorderPoint) {
                progressBar.className = 'progress-bar progress-bar-stock bg-warning';
            } else {
                progressBar.className = 'progress-bar progress-bar-stock bg-success';
            }
        });
    });
    </script>
{% endblock %}