{% extends 'base.html' %}

{% block page_title %}ลูกค้าค้าส่ง{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">ลูกค้าค้าส่ง</h1>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title">ตัวกรอง</h5>
        <form action="{{ url_for('stock.wholesale_dashboard') }}" method="GET" autocomplete="off">
            <div class="row g-3">
                <div class="col-md-5">
                    <label for="search-input" class="form-label">ค้นหาลูกค้า</label>
                    <div class="position-relative">
                        <input type="text" class="form-control" id="search-input" name="search_query" placeholder="พิมพ์ชื่อลูกค้า..." value="{{ search_query or '' }}">
                        <div id="suggestions-box" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="start_date" class="form-label">ตั้งแต่วันที่</label>
                    <input type="text" class="form-control" id="start_date" name="start_date" value="{{ start_date or '' }}" placeholder="เลือกวันที่เริ่มต้น">
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">ถึงวันที่</label>
                    <input type="text" class="form-control" id="end_date" name="end_date" value="{{ end_date or '' }}" placeholder="เลือกวันที่สิ้นสุด">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-primary w-100" type="submit"><i class="fas fa-search"></i></button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">
            ผลการค้นหา ({{ total_customers }} รายการ)
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                {# --- START: ✨ แก้ไขส่วนหัวตารางทั้งหมด --- #}
                <thead>
                    <tr>
                        {% set next_order = 'asc' if order == 'desc' else 'desc' %}
                        <th>
                            <a href="{{ url_for('stock.wholesale_dashboard', page=1, search_query=search_query, start_date=start_date, end_date=end_date, sort_by='name', order=next_order) }}" class="text-decoration-none text-dark">
                                ชื่อลูกค้า {% if sort_by == 'name' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }} ms-1"></i>{% else %}<i class="fas fa-sort ms-1 text-muted"></i>{% endif %}
                            </a>
                        </th>
                        <th class="text-center">สถานะ</th>
                        <th class="text-center">
                            <a href="{{ url_for('stock.wholesale_dashboard', page=1, search_query=search_query, start_date=start_date, end_date=end_date, sort_by='tires', order=next_order) }}" class="text-decoration-none text-dark">
                                ยาง {% if sort_by == 'tires' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }} ms-1"></i>{% else %}<i class="fas fa-sort ms-1 text-muted"></i>{% endif %}
                            </a>
                        </th>
                        <th class="text-center">
                            <a href="{{ url_for('stock.wholesale_dashboard', page=1, search_query=search_query, start_date=start_date, end_date=end_date, sort_by='wheels', order=next_order) }}" class="text-decoration-none text-dark">
                                แม็ก {% if sort_by == 'wheels' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }} ms-1"></i>{% else %}<i class="fas fa-sort ms-1 text-muted"></i>{% endif %}
                            </a>
                        </th>
                        <th class="text-center">
                            <a href="{{ url_for('stock.wholesale_dashboard', page=1, search_query=search_query, start_date=start_date, end_date=end_date, sort_by='spare_parts', order=next_order) }}" class="text-decoration-none text-dark">
                                อะไหล่ {% if sort_by == 'spare_parts' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }} ms-1"></i>{% else %}<i class="fas fa-sort ms-1 text-muted"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{{ url_for('stock.wholesale_dashboard', page=1, search_query=search_query, start_date=start_date, end_date=end_date, sort_by='last_purchase_date', order=next_order) }}" class="text-decoration-none text-dark">
                                วันที่ซื้อล่าสุด {% if sort_by == 'last_purchase_date' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }} ms-1"></i>{% else %}<i class="fas fa-sort ms-1 text-muted"></i>{% endif %}
                            </a>
                        </th>
                        <th></th>
                    </tr>
                </thead>
                {# --- END: ✨ สิ้นสุดการแก้ไขส่วนหัวตาราง --- #}
                <tbody>
                    {% for customer in customers %}
                    <tr>
                        <td>
                            <a href="{{ url_for('stock.wholesale_customer_detail', customer_id=customer.id) }}" class="text-decoration-none">
                                <strong>{{ customer.name }}</strong>
                            </a>
                        </td>
                        <td class="text-center">
                            {% if customer.last_purchase_date %}
                                {% set days_since_purchase = (today.date() - customer.last_purchase_date.date()).days %}
                                {% if days_since_purchase <= 30 %}<span class="badge bg-success">Active</span>{% elif days_since_purchase <= 90 %}<span class="badge bg-warning text-dark">Inactive</span>{% else %}<span class="badge bg-danger">Dormant</span>{% endif %}
                            {% else %}<span class="badge bg-info text-dark">New</span>{% endif %}
                        </td>
                        {# --- START: ✨ แก้ไขการแสดงผลยอดซื้อ --- #}
                        <td class="text-center">{{ customer.tires_purchased }}</td>
                        <td class="text-center">{{ customer.wheels_purchased }}</td>
                        <td class="text-center">{{ customer.spare_parts_purchased }}</td>
                        {# --- END: ✨ สิ้นสุดการแสดงผลยอดซื้อ --- #}
                        <td>
                            {% if customer.last_purchase_date %}
                                {% set dt = customer.last_purchase_date %}{% set year_be = dt.year + 543 %}{% set month_th = THAI_MONTHS[dt.month - 1] %}{{ dt.day }} {{ month_th }} {{ year_be }}, {{ dt.strftime('%H:%M') }}
                            {% else %}<span class="text-muted">ไม่มีประวัติ</span>{% endif %}
                        </td>
                        <td class="text-end">
                             <a href="{{ url_for('stock.wholesale_customer_detail', customer_id=customer.id) }}" class="btn btn-sm btn-outline-secondary">
                                ดูรายละเอียด <i class="fas fa-chevron-right ms-1"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5"> {# <-- แก้ colspan เป็น 7 #}
                            ไม่พบข้อมูลลูกค้าตามเงื่อนไขที่กำหนด
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    {% if total_pages > 1 %}
    <div class="card-footer">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('stock.wholesale_dashboard', page=current_page-1, search_query=search_query, start_date=start_date, end_date=end_date, sort_by=sort_by, order=order) }}">ก่อนหน้า</a>
                </li>
                {% for p in range(1, total_pages + 1) %}
                    <li class="page-item {% if p == current_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('stock.wholesale_dashboard', page=p, search_query=search_query, start_date=start_date, end_date=end_date, sort_by=sort_by, order=order) }}">{{ p }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('stock.wholesale_dashboard', page=current_page+1, search_query=search_query, start_date=start_date, end_date=end_date, sort_by=sort_by, order=order) }}">ถัดไป</a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}        
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    flatpickr("#start_date, #end_date", {
        dateFormat: "Y-m-d", "locale": "th", altInput: true, altFormat: "j F Y",
    });

    const searchInput = $('#search-input');
    const suggestionsBox = $('#suggestions-box');
    let debounceTimeout; 

    searchInput.on('keyup', function() {
        clearTimeout(debounceTimeout);
        let query = $(this).val();
        if (query.length < 2) { suggestionsBox.empty().hide(); return; }
        debounceTimeout = setTimeout(function() {
            $.ajax({
                url: "{{ url_for('stock.api_search_wholesale_customers') }}",
                data: { term: query },
                success: function(data) {
                    suggestionsBox.empty().show();
                    if (data.length > 0) {
                        data.forEach(function(customerName) {
                            let suggestionItem = $('<a href="#" class="list-group-item list-group-item-action"></a>').text(customerName);
                            suggestionItem.on('click', function(e) {
                                e.preventDefault();
                                searchInput.val($(this).text());
                                suggestionsBox.empty().hide();
                                searchInput.closest('form').submit();
                            });
                            suggestionsBox.append(suggestionItem);
                        });
                    } else { suggestionsBox.hide(); }
                }
            });
        }, 300);
    });

    $(document).on('click', function(e) {
        if (!$(e.target).closest('#search-input, #suggestions-box').length) {
            suggestionsBox.empty().hide();
        }
    });
});
</script>
{% endblock %}