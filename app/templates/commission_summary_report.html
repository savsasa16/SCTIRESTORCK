{% extends 'base.html' %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡∏ô{% endblock %}
{% block page_title %}üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡∏ô{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card mb-4">
        <div class="card-body">
            <form id="date-form" method="GET" action="{{ url_for('stock.commission_summary_report') }}">
                <div class="row g-3 align-items-end">
                    <div class="col-md">
                        <label for="start_date" class="form-label"><strong>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</strong></label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date_filter }}">
                    </div>
                    <div class="col-md">
                        <label for="end_date" class="form-label"><strong>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</strong></label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date_filter }}">
                    </div>
                    <div class="col-md-auto">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-calculator me-2"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <i class="fas fa-file-invoice-dollar me-2"></i> 
            <strong>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ start_date_filter }} ‡∏ñ‡∏∂‡∏á {{ end_date_filter }}</strong>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th class="ps-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</th>
                        <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢ (‡∏´‡∏ô‡πà‡∏ß‡∏¢)</th>
                        <th class="text-end pe-3">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in summary_data %}
                    <tr data-bs-toggle="collapse" href="#details-{{ loop.index }}" role="button" aria-expanded="false" aria-controls="details-{{ loop.index }}" class="accordion-toggle">
                        <td class="ps-3">
                            <i class="fas fa-chevron-down me-2"></i>{{ item.item_description }}
                        </td>
                        <td class="text-center">{{ item.total_units_sold | int }}</td>
                        <td class="text-end pe-3 fw-bold">{{ "%.2f"|format(item.total_commission) }}</td>
                    </tr>
                    <tr>
                        <td colspan="3" class="p-0">
                            <div class="collapse" id="details-{{ loop.index }}">
                                <div class="p-3 bg-light">
                                    <h6 class="mb-2"><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:</strong> {{ item.item_description }}</h6>
                                    <table class="table table-sm table-bordered bg-white">
                                        <thead class="table-secondary">
                                            <tr>
                                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</th>
                                                <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                                                <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                                <th class="text-end">‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</th>
                                                <th class="text-center">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for movement in grouped_movements[item.item_description] %}
                                            <tr>
                                                <td>{{ movement.timestamp.strftime('%d/%m/%Y %H:%M') }}</td>
                                                <td>{{ movement.channel_name or 'N/A' }}</td>
                                                <td class="text-center">{{ movement.quantity_change | int }}</td>
                                                <td class="text-end">{{ "%.2f"|format(movement.commission_amount) }}</td>
                                                <td class="text-center">
                                                    {# --- START: ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏π‡∏õ) --- #}
                                                    {% if movement.image_filename %}
                                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#imageProofModal"
                                                            data-image-url="{{ movement.image_filename }}">
                                                        <i class="fas fa-image"></i>
                                                    </button>
                                                    {% else %}
                                                    -
                                                    {% endif %}
                                                    {# --- END: ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏π‡∏õ) --- #}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted p-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if summary_data %}
                <tfoot>
                    {# --- START: ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡∏™‡∏£‡∏∏‡∏õ) --- #}
                    <tr class="bg-success text-white">
                        <td class="text-end fw-bold ps-3" colspan="2">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                        <td class="text-end fw-bold pe-3">
                            {{ "%.2f"|format(summary_data | sum(attribute='total_commission')) }}
                        </td>
                    </tr>
                    {# --- END: ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡∏™‡∏£‡∏∏‡∏õ) --- #}
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>

{# --- START: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î Modal ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà --- #}
<div class="modal fade" id="imageProofModal" tabindex="-1" aria-labelledby="imageProofModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageProofModalLabel">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" id="modalImageProof" class="img-fluid" alt="Proof Image">
      </div>
    </div>
  </div>
</div>
{# --- END: ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Modal --- #}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Flatpickr (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const flatpickrConfig = {
        locale: "th",
        dateFormat: "Y-m-d",
        allowInput: true
    };
    flatpickr("#start_date", flatpickrConfig);
    flatpickr("#end_date", flatpickrConfig);

    // --- START: ‡πÄ‡∏û‡∏¥‡πà‡∏° Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ---
    const imageProofModal = document.getElementById('imageProofModal');
    if (imageProofModal) {
        imageProofModal.addEventListener('show.bs.modal', function (event) {
            // Button that triggered the modal
            const button = event.relatedTarget;
            // Extract image url from data-image-url attribute
            const imageUrl = button.getAttribute('data-image-url');
            
            // Find the image tag inside the modal
            const modalImage = imageProofModal.querySelector('#modalImageProof');
            
            // Update the modal's image source
            modalImage.src = imageUrl;
        });
    }
    // --- END: Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ---
});
</script>
{% endblock %}