{% extends 'base.html' %}

{% block title %}‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢{% endblock %}
{% block page_title %}üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢{% endblock %}

{% block styles %}
    {# ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ block styles ‡πÅ‡∏ó‡∏ô head ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö #}
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('stock.sales_history_search') }}">
                <div class="row g-3">
                    <div class="col-md-6 col-lg-3">
                        <label for="tire-search" class="form-label"><strong>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</strong></label>
                        <input type="text" name="tire_keyword_display" id="tire-search" class="form-control" placeholder="‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/‡∏£‡∏∏‡πà‡∏ô/‡∏Ç‡∏ô‡∏≤‡∏î..." value="{{ tire_keyword or '' }}">
                        <input type="hidden" name="tire_id" id="tire-id-hidden" value="{{ request.args.get('tire_id', '') }}">
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="customer-search" class="form-label"><strong>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</strong></label>
                        <input type="text" name="customer_keyword" id="customer-search" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." value="{{ customer_keyword or '' }}">
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <label for="start-date-picker" class="form-label"><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</strong></label>
                        <input type="date" name="start_date" id="start-date-picker" class="form-control" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..." value="{{ start_date or '' }}">
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <label for="end-date-picker" class="form-label"><strong>‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</strong></label>
                        <input type="date" name="end_date" id="end-date-picker" class="form-control" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..." value="{{ end_date or '' }}">
                    </div>
                    <div class="col-lg-2 d-flex align-items-end">
                        <div class="w-100">
                             <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                             <a href="{{ url_for('stock.sales_history_search') }}" class="btn btn-outline-secondary w-100 mt-2">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if has_searched %}
        {% if sales_history %}
        <h4>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ({{ sales_history|length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h4>
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th scope="col" class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th scope="col">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏á</th>
                                <th scope="col">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Ç‡∏≤‡∏¢</th>
                                <th scope="col">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th scope="col">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                <th scope="col">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in sales_history %}
                            <tr>
                                <td class="text-nowrap">{{ sale.timestamp.day }} {{ THAI_MONTHS[sale.timestamp.month - 1] }} {{ sale.timestamp.year + 543 }} {{ sale.timestamp.strftime('%H:%M') }}</td>
                                <td class="text-center">{{ sale.quantity_change }}</td>
                                <td>{{ sale.tire_brand }} {{ sale.tire_model }} ({{ sale.tire_size }})</td>
                                <td>{{ sale.channel_name }}</td>
                                <td>
                                    {% if sale.online_platform_name %}
                                        {{ sale.online_platform_name }}
                                    {% elif sale.wholesale_customer_name %}
                                        {{ sale.wholesale_customer_name }}
                                    {% else %}
                                        ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô
                                    {% endif %}
                                </td>
                                <td>{{ sale.user_username }}</td>
                                <td>{{ sale.notes }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h5 class="card-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                        <p class="card-text fs-4 fw-bold text-success">{{ total_all_items }} ‡πÄ‡∏™‡πâ‡∏ô</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h5 class="card-title">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</h5>
                        {% if total_by_brand %}
                        <ul class="list-group list-group-flush">
                            {% for brand, total in total_by_brand.items()|sort %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <strong>{{ brand.title() }}</strong>
                                    <span class="badge bg-primary rounded-pill">{{ total }} ‡πÄ‡∏™‡πâ‡∏ô</span>
                                </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                            <p class="text-muted text-center mt-3 mb-0">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-circle me-2"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </div>
        {% endif %}
    {% else %}
        <div class="alert alert-info">
            <h5 class="alert-heading"><i class="fas fa-info-circle"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h5>
            <p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ:</p>
            <ul>
                <li><strong>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠, ‡∏£‡∏∏‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏¢‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</li>
                <li><strong>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á) ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)</li>
                <li><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</li>
            </ul>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
    {# ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î jQuery ‡πÅ‡∏•‡∏∞ jQuery UI ‡∏≠‡∏µ‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô base.html ‡πÅ‡∏•‡πâ‡∏ß #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Autocomplete ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤‡∏á
        $("#tire-search").autocomplete({
            source: function(request, response) {
                $.getJSON("{{ url_for('stock.api_search_tires_for_autocomplete') }}", {
                    term: request.term
                }, response);
            },
            minLength: 2,
            select: function(event, ui) {
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÉ‡∏ô hidden input ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                $("#tire-id-hidden").val(ui.item.id);
                $("#tire-search").val(ui.item.value); 
                return false; 
            }
        });

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Autocomplete ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        $("#customer-search").autocomplete({
            source: function(request, response) {
                $.getJSON("{{ url_for('stock.api_search_customers') }}", {
                    term: request.term
                }, response);
            },
            minLength: 2
        });
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Flatpickr
        flatpickr("#start-date-picker", {
            locale: "th",
            dateFormat: "Y-m-d",
        });
        flatpickr("#end-date-picker", {
            locale: "th",
            dateFormat: "Y-m-d",
        });
    });
    </script>
{% endblock %}